<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard de Procesamiento de F8</title>
  
  <link rel="icon" href="assets/logo.png"/>

  <!-- LibrerÃ­as -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Iconos tipo texto (Material Symbols) -->
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400;600&display=swap" />

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json"/>

  <link rel="stylesheet" href="flow-styles.css?v=2.4"/>
</head>
<body>
  <header class="app-header">
    <div class="brand">
      <img src="assets/logo.png" alt="logo" width="40" height="40"/>
      <div>
        <h1>Dashboard de Procesamiento de F8</h1>
        <small>Seguimiento de Flujo de Requisiciones - v2.0 - Torre de Control</small>
      </div>
    </div>
    <div class="header-actions">
      <a href="index.html" class="btn-link">Vista ClÃ¡sica</a>
      <button id="btnLogin">Acceder</button>
      <button id="btnEditMode" disabled>Modo ediciÃ³n: OFF</button>
      <button id="btnRefresh">Actualizar</button>
    </div>
  </header>

  <!-- Franja superior: FILTROS + BLOQUES + KPIs TODO EN UNA SOLA FILA -->
  <div class="top-wrapper">
    <div class="top-row">
      <!-- Columna izquierda: filtros -->
      <section class="top-filters">
        <div class="filters-buttons-row">
          <button id="btnClearFilter" style="display:none;">Limpiar filtro</button>
          <button id="btnExport" title="Exportar datos">ðŸ“Š Exportar</button>
        </div>
        <div class="filters-selects-column">
          <select id="flowFilterComent">
            <option value="">Todos los comentarios</option>
            <option value="DISCREPANCIA DE INVENTARIO">DISCREPANCIA DE INVENTARIO</option>
            <option value="FALTA DE PERSONAL">FALTA DE PERSONAL</option>
            <option value="VIATICOS PARA VIAJES">VIATICOS PARA VIAJES</option>
            <option value="FALTA MONTACARGA">FALTA MONTACARGA</option>
            <option value="CONGESTIONAMIENTO EN SALIDAS">CONGESTIONAMIENTO EN SALIDAS</option>
            <option value="FACTURACION RETRASADA">FACTURACION RETRASADA</option>
            <option value="FALLAS EN SISTEMA">FALLAS EN SISTEMA</option>
            <option value="DEMORA EN DOCUMENTACION">DEMORA EN DOCUMENTACION</option>
            <option value="ERROR DE CAPTACION">ERROR DE CAPTACION</option>
            <option value="ENTREGADO">ENTREGADO</option>
          </select>
          <select id="flowFilterUnidad">
            <option value="">Todas las unidades</option>
          </select>
          <select id="flowFilterGrupo">
            <option value="">Todos los grupos</option>
          </select>
        </div>
      </section>

      <!-- Bloques del Flujo de Proceso (centro) -->
      <section id="process-flow">
        <div class="flow-block" data-stage="RECIBO" data-days="0">
          <div class="flow-block-icon">
            <span class="material-symbols-outlined">mark_email_unread</span>
          </div>
          <div class="flow-block-header">RECIBO F8</div>
          <div class="flow-block-count" id="count-recibo">0</div>
          <div class="flow-block-label">Requisiciones</div>
          <div class="flow-block-days">DÃ­a 0</div>
        </div>
        <div class="flow-arrow">â†’</div>
        <div class="flow-block" data-stage="ASIGNACION" data-days="1">
          <div class="flow-block-icon">
            <span class="material-symbols-outlined">assignment_ind</span>
          </div>
          <div class="flow-block-header">ASIGNACIÃ“N</div>
          <div class="flow-block-count" id="count-asignacion">0</div>
          <div class="flow-block-label">Requisiciones</div>
          <div class="flow-block-days">+1 dÃ­a</div>
        </div>
        <div class="flow-arrow">â†’</div>
        <div class="flow-block" data-stage="SALIDA" data-days="2">
          <div class="flow-block-icon">
            <span class="material-symbols-outlined">exit_to_app</span>
          </div>
          <div class="flow-block-header">SALIDA</div>
          <div class="flow-block-count" id="count-salida">0</div>
          <div class="flow-block-label">Requisiciones</div>
          <div class="flow-block-days">+1 dÃ­a</div>
        </div>
        <div class="flow-arrow">â†’</div>
        <div class="flow-block" data-stage="DESPACHO" data-days="3">
          <div class="flow-block-icon">
            <span class="material-symbols-outlined">outbox</span>
          </div>
          <div class="flow-block-header">DESPACHO</div>
          <div class="flow-block-count" id="count-despacho">0</div>
          <div class="flow-block-label">Requisiciones</div>
          <div class="flow-block-days">+1 dÃ­a</div>
        </div>
        <div class="flow-arrow">â†’</div>
        <div class="flow-block" data-stage="FACTURACION" data-days="4">
          <div class="flow-block-icon">
            <span class="material-symbols-outlined">request_quote</span>
          </div>
          <div class="flow-block-header">FACTURACIÃ“N</div>
          <div class="flow-block-count" id="count-facturacion">0</div>
          <div class="flow-block-label">Requisiciones</div>
          <div class="flow-block-days">+3 dÃ­a</div>
        </div>
        <div class="flow-arrow">â†’</div>
        <div class="flow-block" data-stage="EMPACADO" data-days="5">
          <div class="flow-block-icon">
            <span class="material-symbols-outlined">inventory_2</span>
          </div>
          <div class="flow-block-header">EMPACADO</div>
          <div class="flow-block-count" id="count-empacado">0</div>
          <div class="flow-block-label">Requisiciones</div>
          <div class="flow-block-days">+1 dÃ­as</div>
        </div>
        <div class="flow-arrow">â†’</div>
        <div class="flow-block" data-stage="ENTREGA" data-days="9">
          <div class="flow-block-icon">
            <span class="material-symbols-outlined">local_shipping</span>
          </div>
          <div class="flow-block-header">PROY. ENTREGA</div>
          <div class="flow-block-count" id="count-entrega">0</div>
          <div class="flow-block-label">Requisiciones</div>
          <div class="flow-block-days">+1 dÃ­a</div>
        </div>
      </section>

      <!-- KPIs a la derecha -->
      <section id="quick-stats">
        <div class="stat-card">
          <div class="stat-label">Total</div>
          <div class="stat-value" id="stat-total">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">En Proceso</div>
          <div class="stat-value" id="stat-proceso">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Completados</div>
          <div class="stat-value" id="stat-completados">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Con Retraso</div>
          <div class="stat-value stat-danger" id="stat-retraso">0</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Contenedor principal de dos columnas -->
  <div class="main-container">
    <section class="left-panel">
      <div class="panel-header">
        <h2 id="panel-title">Requisiciones del 2025-12-12</h2>
      </div>
      <div class="orders-list" id="ordersList">
        <p class="loading-message">Cargando requisiciones...</p>
      </div>
    </section>

    <section class="right-panel">
      <div class="calendar-and-monthly">
        <div class="calendar-container">
          <div class="calendar-header">
            <button id="btnPrevMonth">â—€</button>
            <h3 id="calendarTitle">Diciembre 2025</h3>
            <button id="btnNextMonth">â–¶</button>
          </div>
          <div id="calendar" class="calendar-grid"></div>
          <div class="calendar-legend">
            <div class="legend-item">
              <span class="legend-color" style="background:#ef4444"></span>
              <span>Vencido</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background:#f59e0b"></span>
              <span>Hoy</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background:#3b82f6"></span>
              <span>Programado</span>
            </div>
          </div>
        </div>

        <div class="monthly-checklist-container">
          <h3>Checklist Mensuales <span id="monthlyDateLabel"></span></h3>
          <div id="monthlyChecklist">
            <p class="loading-message">Seleccione un dÃ­a con mensuales para ver el resumen.</p>
          </div>
        </div>
      </div>

      <div class="gap-analysis-container">
        <h3>AnÃ¡lisis de Deltas (TeÃ³rico vs Real)</h3>
        <canvas id="gapChart"></canvas>
      </div>

      <div class="time-kpis">
        <div class="time-kpi">
          <div class="kpi-label">Tiempo promedio teÃ³rico</div>
          <div class="kpi-value" id="kpi-teorico">â€”</div>
        </div>
        <div class="time-kpi">
          <div class="kpi-label">Tiempo promedio real</div>
          <div class="kpi-value" id="kpi-real">â€”</div>
        </div>
        <div class="time-kpi">
          <div class="kpi-label">Delta promedio</div>
          <div class="kpi-value" id="kpi-delta">â€”</div>
        </div>
        <div class="time-kpi">
          <div class="kpi-label">Delta acumulado</div>
          <div class="kpi-value" id="kpi-acumulado">â€”</div>
        </div>
      </div>

      <div class="stage-deltas-container">
        <h3>Deltas por Etapa del Proceso</h3>
        <canvas id="stageDeltas"></canvas>
      </div>
    </section>
  </div>

  <!-- MODAL DE EDICIÃ“N PARA VISTA FLUJO -->
  <div id="editModal" class="flow-edit-modal" style="display:none;">
    <div class="flow-edit-backdrop"></div>
    <div class="flow-edit-dialog">
      <div class="flow-edit-header">
        <h3 id="editModalTitle">Editar requisiciÃ³n</h3>
        <button id="editModalClose" class="flow-edit-close">âœ•</button>
      </div>
      <div class="flow-edit-body">
        <div class="flow-edit-row">
          <label>F8 SALMI</label>
          <div id="editFieldId" class="flow-edit-readonly">â€”</div>
        </div>

        <div class="flow-edit-row">
          <label>Unidad</label>
          <div id="editFieldUnidad" class="flow-edit-readonly">â€”</div>
        </div>

        <div class="flow-edit-row">
          <label>Grupo</label>
          <div id="editFieldGrupo" class="flow-edit-readonly">â€”</div>
        </div>

        <div class="flow-edit-grid">
          <div>
            <label>AsignaciÃ³n</label>
            <input type="date" id="editFieldAsignacion"/>
          </div>
          <div>
            <label>Salida</label>
            <input type="date" id="editFieldSalida"/>
          </div>
          <div>
            <label>Despacho</label>
            <input type="date" id="editFieldDespacho"/>
          </div>
          <div>
            <label>FacturaciÃ³n</label>
            <input type="date" id="editFieldFacturacion"/>
          </div>
          <div>
            <label>Empacado</label>
            <input type="date" id="editFieldEmpacado"/>
          </div>
          <div>
            <label>Proy. Entrega</label>
            <input type="date" id="editFieldProy"/>
          </div>
          <div>
            <label>Entrega Real</label>
            <input type="date" id="editFieldReal"/>
          </div>
        </div>

        <div class="flow-edit-row">
          <label>Comentario</label>
          <select id="editFieldComent">
            <option value="">(sin comentario)</option>
            <option value="DISCREPANCIA DE INVENTARIO">DISCREPANCIA DE INVENTARIO</option>
            <option value="FALTA DE PERSONAL">FALTA DE PERSONAL</option>
            <option value="VIATICOS PARA VIAJES">VIATICOS PARA VIAJES</option>
            <option value="FALTA MONTACARGA">FALTA MONTACARGA</option>
            <option value="CONGESTIONAMIENTO EN SALIDAS">CONGESTIONAMIENTO EN SALIDAS</option>
            <option value="FACTURACION RETRASADA">FACTURACION RETRASADA</option>
            <option value="FALLAS EN SISTEMA">FALLAS EN SISTEMA</option>
            <option value="DEMORA EN DOCUMENTACION">DEMORA EN DOCUMENTACION</option>
            <option value="ERROR DE CAPTACION">ERROR DE CAPTACION</option>
            <option value="ENTREGADO">ENTREGADO</option>
          </select>
        </div>

        <div id="editModalMessage" class="flow-edit-message"></div>
      </div>
      <div class="flow-edit-footer">
        <button id="editModalSave" class="flow-edit-save">Guardar cambios</button>
        <button id="editModalCancel" class="flow-edit-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
    window.APP = {
      A_URL: 'https://script.google.com/macros/s/AKfycbxMr-fkiplPoBPm_x6V9ZnEMB9-Kd6ZH1tvKG2t8zIcFNYF8t-gF1JP2d6bRo9BGHgFTA/exec',
      B_URL: 'https://script.google.com/macros/s/AKfycbysdeYW1g-l1p6ZOyk9aPaUIdx5H4GbzYFVeD1T8_SsyQoODqo-dSzjQMeu7lZzYmQ/exec',
      CLIENT_ID: '63868073848-8bfis5g0f8mt14oia3flmbqksg69tejq.apps.googleusercontent.com'
    };

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .catch(err => console.log('SW registration failed', err));
      });
    }
  </script>

  <script src="flow-app.js?v=2.5"></script>
</body>
</html>
